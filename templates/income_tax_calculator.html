{% extends "layout.html" %}

{% block title %}Income Tax Calculator{% endblock %}

{% block content %}
    <a href="{{ url_for('home') }}" class="nav-back">â† Back to Home</a>
    
    <div style="text-align: center;">
      <div class="lang-toggle">
        <button id="btn-en" class="active" onclick="toggleLanguage('en')">EN</button>
        <button id="btn-jp" onclick="toggleLanguage('jp')">JP</button>
      </div>
    </div>

    <h1 id="main-title">National Income Tax Calculator</h1>
    <p class="subtitle" id="subtitle">Estimate your national income tax based on your taxable income.</p>

    <!-- --- TAXABLE INCOME INPUT --- -->
    <div class="form-group">
      <div class="label-with-icon">
        <label for="taxable-income-input" id="label-taxable-income">Your Taxable Income (èª²ç¨æ‰€å¾—) (Â¥)</label>
        <i class="info-icon">i</i>
        <span class="tooltiptext" id="tooltip-taxable-income">Enter your final taxable income amount. This is your gross salary after all deductions (salary, social insurance, basic, dependent, etc.) have been applied.</span>
      </div>
      <input type="number" id="taxable-income-input" oninput="calculateIncomeTax()" placeholder="e.g., 3500000">
    </div>

    <hr>
    
    <!-- --- CALCULATION BREAKDOWN --- -->
    <h2 id="calc-breakdown-title" style="text-align: center; font-weight: 500; color: var(--label-color); margin-bottom: 30px;">Calculation Breakdown</h2>

    <div class="results-grid">
      <div class="form-group">
        <div class="label-with-icon">
          <span class="icon result-icon">ğŸ“Š</span>
          <label for="tax-rate" id="label-tax-rate">Applicable Tax Rate</label>
           <i class="info-icon">i</i>
           <span class="tooltiptext" id="tooltip-tax-rate">The tax rate is determined by which income bracket your taxable income falls into.</span>
        </div>
        <input type="text" id="tax-rate" readonly>
      </div>
      
      <div class="form-group">
        <div class="label-with-icon">
          <span class="icon deduction-icon">ğŸ”»</span>
          <label for="fixed-deduction" id="label-fixed-deduction">Fixed Deduction (æ§é™¤é¡)</label>
          <i class="info-icon">i</i>
          <span class="tooltiptext" id="tooltip-fixed-deduction">A fixed amount corresponding to your tax bracket, subtracted after applying the tax rate.</span>
        </div>
        <input type="text" id="fixed-deduction" readonly>
      </div>
    </div>

    <!-- --- FINAL TAX ESTIMATE --- -->
    <div class="form-group">
        <div class="label-with-icon">
          <span class="icon result-icon">ğŸ§¾</span>
          <label for="total-income-tax" id="label-total-tax">Total Estimated Annual Income Tax (æ‰€å¾—ç¨)</label>
          <i class="info-icon">i</i>
          <span class="tooltiptext" id="tooltip-total-tax">The final calculated amount. Formula: (Taxable Income Ã— Rate) - Fixed Deduction.</span>
        </div>
        <input type="text" id="total-income-tax" readonly style="font-size: 20px; text-align: center; color: var(--success-color);">
    </div>
    
    <!-- START: NEW MONTHLY TAX FIELD -->
    <div class="form-group">
        <div class="label-with-icon">
          <span class="icon result-icon">ğŸ—“ï¸</span>
          <label for="monthly-income-tax" id="label-monthly-tax">Estimated Monthly Income Tax</label>
          <i class="info-icon">i</i>
          <span class="tooltiptext" id="tooltip-monthly-tax">The annual income tax amount divided by 12. This is often withheld from your monthly salary.</span>
        </div>
        <input type="text" id="monthly-income-tax" readonly>
    </div>
    <!-- END: NEW MONTHLY TAX FIELD -->

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    const translations = {
        en: {
            'main-title': 'National Income Tax Calculator',
            'subtitle': 'Estimate your national income tax based on your taxable income.',
            'label-taxable-income': 'Your Taxable Income (èª²ç¨æ‰€å¾—) (Â¥)',
            'tooltip-taxable-income': 'Enter your final taxable income amount. This is your gross salary after all deductions (salary, social insurance, basic, dependent, etc.) have been applied.',
            'calc-breakdown-title': 'Calculation Breakdown',
            'label-tax-rate': 'Applicable Tax Rate',
            'tooltip-tax-rate': 'The tax rate is determined by which income bracket your taxable income falls into.',
            'label-fixed-deduction': 'Fixed Deduction (æ§é™¤é¡)',
            'tooltip-fixed-deduction': 'A fixed amount corresponding to your tax bracket, subtracted after applying the tax rate.',
            'label-total-tax': 'Total Estimated Annual Income Tax (æ‰€å¾—ç¨)',
            'tooltip-total-tax': 'The final calculated amount. Formula: (Taxable Income Ã— Rate) - Fixed Deduction.',
            // New Translations
            'label-monthly-tax': 'Estimated Monthly Income Tax',
            'tooltip-monthly-tax': 'The annual income tax amount divided by 12. This is often withheld from your monthly salary.'
        },
        jp: {
            'main-title': 'æ‰€å¾—ç¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼',
            'subtitle': 'èª²ç¨æ‰€å¾—ã‚’åŸºã«ã€å›½ç¨ã§ã‚ã‚‹æ‰€å¾—ç¨ã‚’è¨ˆç®—ã—ã¾ã™ã€‚',
            'label-taxable-income': 'ã‚ãªãŸã®èª²ç¨æ‰€å¾— (å††)',
            'tooltip-taxable-income': 'æœ€çµ‚çš„ãªèª²ç¨æ‰€å¾—é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ã“ã‚Œã¯ã€çµ¦ä¸æ‰€å¾—æ§é™¤ã€ç¤¾ä¼šä¿é™ºæ–™æ§é™¤ã€åŸºç¤æ§é™¤ã€æ‰¶é¤Šæ§é™¤ãªã©ã€ã™ã¹ã¦ã®æ§é™¤ãŒé©ç”¨ã•ã‚ŒãŸå¾Œã®é‡‘é¡ã§ã™ã€‚',
            'calc-breakdown-title': 'è¨ˆç®—ã®å†…è¨³',
            'label-tax-rate': 'é©ç”¨ç¨ç‡',
            'tooltip-tax-rate': 'ã‚ãªãŸã®èª²ç¨æ‰€å¾—ãŒã©ã®æ‰€å¾—åŒºåˆ†ã«è©²å½“ã™ã‚‹ã‹ã«ã‚ˆã£ã¦ç¨ç‡ãŒæ±ºã¾ã‚Šã¾ã™ã€‚',
            'label-fixed-deduction': 'æ§é™¤é¡',
            'tooltip-fixed-deduction': 'ã‚ãªãŸã®ç¨ç‡åŒºåˆ†ã«å¯¾å¿œã™ã‚‹å›ºå®šé¡ã§ã€ç¨ç‡ã‚’é©ç”¨ã—ãŸå¾Œã«å·®ã—å¼•ã‹ã‚Œã¾ã™ã€‚',
            'label-total-tax': 'æ‰€å¾—ç¨ã®å¹´é–“åˆè¨ˆï¼ˆç›®å®‰ï¼‰',
            'tooltip-total-tax': 'æœ€çµ‚çš„ãªè¨ˆç®—çµæœã§ã™ã€‚è¨ˆç®—å¼: (èª²ç¨æ‰€å¾— Ã— ç¨ç‡) - æ§é™¤é¡ã€‚',
            // New Translations
            'label-monthly-tax': 'æœˆã€…ã®æ‰€å¾—ç¨ï¼ˆç›®å®‰ï¼‰',
            'tooltip-monthly-tax': 'å¹´é–“ã®æ‰€å¾—ç¨é¡ã‚’12ã§å‰²ã£ãŸé‡‘é¡ã§ã™ã€‚é€šå¸¸ã€æ¯æœˆã®çµ¦ä¸ã‹ã‚‰æºæ³‰å¾´åã•ã‚Œã¾ã™ã€‚'
        }
    };

    window.toggleLanguage = function(lang) {
        for (const id in translations[lang]) {
            const element = document.getElementById(id);
            if (element) {
                element.innerHTML = translations[lang][id];
            }
        }
        document.querySelectorAll('.lang-toggle button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${lang}`).classList.add('active');
    };

    window.calculateIncomeTax = function() {
        const taxableIncomeInput = document.getElementById('taxable-income-input');
        const taxableIncome = parseInt(taxableIncomeInput.value) || 0;

        if (taxableIncome === 0) {
            clearFields();
            return;
        }

        let rate = 0;
        let deduction = 0;

        if (taxableIncome <= 1950000) { rate = 0.05; deduction = 0; } 
        else if (taxableIncome <= 3300000) { rate = 0.10; deduction = 97500; } 
        else if (taxableIncome <= 6950000) { rate = 0.20; deduction = 427500; } 
        else if (taxableIncome <= 9000000) { rate = 0.23; deduction = 636000; } 
        else if (taxableIncome <= 18000000) { rate = 0.33; deduction = 1536000; } 
        else if (taxableIncome <= 40000000) { rate = 0.40; deduction = 2796000; } 
        else { rate = 0.45; deduction = 4796000; }

        const incomeTax = Math.round((taxableIncome * rate) - deduction);
        
        // START: NEW MONTHLY CALCULATION
        const monthlyIncomeTax = Math.round(incomeTax / 12);
        // END: NEW MONTHLY CALCULATION

        // Update the UI with formatted values
        document.getElementById('tax-rate').value = `${rate * 100}%`;
        document.getElementById('fixed-deduction').value = `Â¥ ${deduction.toLocaleString()}`;
        document.getElementById('total-income-tax').value = `Â¥ ${incomeTax.toLocaleString()}`;
        // START: NEW UI UPDATE
        document.getElementById('monthly-income-tax').value = `Â¥ ${monthlyIncomeTax.toLocaleString()}`;
        // END: NEW UI UPDATE
    };

    function clearFields() {
        const idsToClear = [
            'tax-rate', 
            'fixed-deduction', 
            'total-income-tax', 
            'monthly-income-tax' // Add new field to the clear list
        ];
        idsToClear.forEach(id => {
            document.getElementById(id).value = '';
        });
    }

    // Initialize the language and clear fields on load
    toggleLanguage('en');
    clearFields();
});
</script>
{% endblock %}